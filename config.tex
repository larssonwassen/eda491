\section{Firewall Configuration}
\label{sec:config}

A final firewall configuration is shown in Listing \ref{lst:fw-config} and displays all the firewall's rules created during the \lab{}. The initial firewall configuration in section \ref{sec:setup} is a subset of this final firewall configuration due to that the initial configuration has rules that are needed to operate the computer. We added a number of rules that are presented here below but we also changed the default policy from ACCEPT to DROP for all the chains INPUT, OUTPUT and FORWARD. The default policy DROP is more secure as explained in section \ref{sec:setup}. The chains of interest in this \lab{} were INPUT and OUTPUT and the other chains are not considered or tested. To configure the firewall, the script in Appendix~\ref{app:fw-final} was issued.

The added rules made certain that unwanted traffic were dropped and valid traffic accepted, to some extent. First, all the traffic where checked for malicious or malformed content and dropped if they matched any of those rules. The denying rules covered IP spoofing and ping flooding. Second followed a number of rules that checked whether the content seemed valid and if a packed matched any of these rules, it was accepted and forwarded. The allowing rules let through a limited amount of ping requests, established TCP connections, traffic sent in loopback mode, outgoing traffic and traffic to specified services. Lastly was the traffic that had not been matched by either the denying or the allowing rules logged before the default policy - drop - was issued. The rules with their purpose and the mentioned organization can easily be seen in the script in Appendix~\ref{app:fw-final} and in the continued text the rules will be referred to where in Listing \ref{lst:fw-config} they can be found.

The first problem was concerning IP spoofing. It is not possible to ensure that an IP is not spoofed, so there is no way to completely overcome this problem. What usually is done - and what we also did - was to drop all incoming packages with a source IP address that did not belong to the current network, which correspond to the rules on lines 4-7. Further was rules from line 31 to 46 added to drop all the outgoing traffic that either had a source or a destination IP address that did not belong to the current network. 

The second problem was ping flooding. A few ping messages are normal to receive and also important to answer by transmitting an echo, but ping request can also be used as an DOS attack and for that reason a defined number of echo requests per second can be reasonable to accept into the system. The rule on line 10 restrict the number of accepted echo requests to one per second and it will be applied after a burst of five answered echo requests. To drop the remaining echo requests that was not accepted by the restriction rule, a rule on line 11 was added to drop all echo requests. Without this rule, the echo request would be accepted by the rules mentioned next.

The allowing rules accepts established and related connections, traffic sent in loopback mode, outgoing traffic and traffic to selected services. The rule at line 12  accepts all connections with the states either related or established. The loopback traffic is accepted by the rules on rows 11 and 47, which accepts traffic to and from the \texttt{lo} interface. On line 19 is the rule regarding to accept all outgoing traffic to and from any destination, but remember that traffic with invalid addresses have been dropped by earlier rules. Rules from line 12 to 17 concerns traffic using both UDP and TCP to the services SSH Server, Web Server and portmapper on respective ports 22, 8080 and 111.

The traffic that had not been either dropped or accepted and thus will be taken care of by the default policy, i.e. dropped, was logged before the action was taken. The traffic logged are either malicious data that have avoided the denying rules or legitimate data that has not been accepted. It is in the firewall administrators interest to somehow look through the log, especially if user reports service problems, but also to evaluate what attacks that are carried out against the protected system. By using a program such as Wireshark the administrator can possibly identify threats, but also valid user data that somehow don't get accepted by a rule and with this information can update the rules so that the service can function as intended. 

The rules seen in Listing \ref{lst:fw-config} that has not been addressed by the above text are the rules from the initial firewall configuration, which are described in section \ref{sec:setup}.

\lstinputlisting[caption=Final firewall 
configuration,label=lst:fw-config]{firewall-final.txt}